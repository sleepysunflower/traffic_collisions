import{j as e,R as a,a as P,E as G}from"./index-d1rH2Q1h.js";import{r as ge,u as je,l as _e,g as ye,m as V,a as ve}from"./mtheme-6RA9WA7a.js";function Ne(){return e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"About this model"}),e.jsxs("details",{open:!0,children:[e.jsx("summary",{children:"Objective"}),e.jsx("div",{className:"text-sm",style:{marginTop:8,lineHeight:1.6},children:e.jsxs("p",{children:["Quantify ",e.jsx("strong",{children:"monthly collision risk"})," across urban cells and explain variation via built environment, traffic, and weather factors."]})})]}),e.jsxs("details",{style:{marginTop:10},open:!0,children:[e.jsx("summary",{children:"Spatial framework"}),e.jsx("div",{className:"text-sm",style:{marginTop:8,lineHeight:1.6},children:e.jsxs("p",{children:["The Island of Montréal is divided into ",e.jsx("strong",{children:"H3 resolution 9"})," hexagons (~315 m). Each hex cell is a consistent spatial unit for aggregating and modeling collisions."]})})]}),e.jsxs("details",{style:{marginTop:10},open:!0,children:[e.jsx("summary",{children:"Monthly panel & features"}),e.jsxs("div",{className:"text-sm",style:{marginTop:8,lineHeight:1.6},children:[e.jsxs("p",{children:["Build a unified ",e.jsx("em",{children:"hex × month"})," table combining:"]}),e.jsxs("ul",{style:{marginLeft:18},children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Built environment (static):"})," AADT raster mean per hex, Population (areal-weighted), Intersection density, POI counts/types, Land-use proportions."]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Road condition (PCI, IRI):"})," Aggregated from surveys (2010, 2015, 2018, 2020); choose the latest survey ≤ current year-month (length/area-weighted)."]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Weather (monthly):"})," city-level averages by month (temperature, precipitation, snow, etc.)."]})]})]})]}),e.jsxs("details",{style:{marginTop:10},open:!0,children:[e.jsx("summary",{children:"Target"}),e.jsx("div",{className:"text-sm",style:{marginTop:8,lineHeight:1.6},children:e.jsxs("p",{children:[e.jsx("strong",{children:"collision_count"})," = number of collisions per ",e.jsx("em",{children:"hex × month"})," (with auxiliary severity indicators). We fit on ",e.jsx("code",{children:"log1p(collision_count)"}),"."]})})]}),e.jsxs("details",{style:{marginTop:10},open:!0,children:[e.jsx("summary",{children:"Model training & evaluation"}),e.jsxs("div",{className:"text-sm",style:{marginTop:8,lineHeight:1.6},children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Algorithm:"})," ",e.jsx("code",{children:"RandomForestRegressor"})," (light, regularized)."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Predictors:"})," all features except IDs, time columns, and severity fields."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Split:"})," 80/20 train–test."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Base config:"})," 300 trees, ",e.jsx("code",{children:"max_depth=20"}),","," ",e.jsx("code",{children:"min_samples_leaf=5"}),", ",e.jsx("code",{children:"max_samples=0.7"}),"."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Metrics:"})," MAE, RMSE, R² on test set."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Feature selection:"})," rank by Gini importance → keep top 60 → retrain final RF."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Permutation importance (mini):"})," 10,000-row subsample × 5 repeats for interpretability."]})]})]})]})}function be(t){const i=t.features??t.feature_names??t.input_features??t.columns??[],d=t.model_name??t.name??t.model??"",p=t.target??t.y_name??t.dependent??"",x=t.is_log_target??t.log_target??!1;let f=t.feature_info;return{model_name:d,target:p,is_log_target:!!x,features:Array.isArray(i)?i.map(String):[],feature_info:f}}async function Ce(t="/data/models/occurrence_meta.json"){const i=await fetch(t);if(!i.ok)throw new Error(`Failed to load occurrence meta: ${i.status} ${i.statusText}`);const d=await i.json(),p=be(d);return p.features?.length||console.warn("Occurrence meta has no features. Raw keys:",Object.keys(d)),p}const Se="https://pub-853864c73d334eac8a44f5923b069c11.r2.dev/collision/occurrence.onnx",we=P("data/models/occurrence_meta.json"),Ie=P("data/dictionary.json"),Re=P("data/models/occurrence_gini.csv"),K={base_MAE:.37910470803572993,base_RMSE:.7530542861106703,base_R2:.3747244524635951,final_MAE:.37179685744658203,final_RMSE:.7396369785036166,final_R2:.39680725777706793};function Y(t,i,d){return Math.max(i,Math.min(d,t))}function Me(t){const i=t.match(/^RC_rc_(\d{4})_(?:etat|indice)[ _]*(iri|pci)/i);return i?(i[1]||"").toUpperCase()==="PCI"?"PCI value":"IRI value":t.startsWith("landuse__")?"Land use":t.startsWith("poi_type__")?"POI type":t==="aadt"||t==="aadt_mean"?"AADT (avg daily traffic)":t==="population_aw"||t==="population"?"Population (area weighted)":t==="pop_density"?"Population density":t==="intersection_count"?"Intersection count":/_v$/.test(t)?t.replace(/_v$/,"").replaceAll("_"," "):t==="year"||t==="annee"?"Year":t}function Ae(t){const i=new Set,d=new Set,p=new Set;let x=!1,f=!1;const y=[];for(const m of t){if(m.startsWith("landuse__")){i.add(m.slice(9));continue}if(m.startsWith("poi_type__")){d.add(m.slice(10));continue}const _=m.match(/^RC_rc_(\d{4})_(?:etat|indice)[ _]*(iri|pci)/i);if(_){p.add(Number(_[1])),(_[2]||"").toLowerCase()==="pci"&&(x=!0),(_[2]||"").toLowerCase()==="iri"&&(f=!0);continue}y.push(m)}return{landuse:i.size?Array.from(i):void 0,poi_type:d.size?Array.from(d):void 0,rc_years:Array.from(p).filter(m=>m!==2020).sort(),rc_hasPCI:x,rc_hasIRI:f,atomic:y}}function Pe({pct:t}){const x=2*Math.PI*25,f=Math.max(0,Math.min(100,t)),y=x*(1-f/100);return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[e.jsxs("svg",{width:56,height:56,viewBox:"0 0 56 56",children:[e.jsx("circle",{cx:56/2,cy:56/2,r:25,stroke:"#2a2a2a",strokeWidth:6,fill:"none"}),e.jsx("circle",{cx:56/2,cy:56/2,r:25,stroke:"#8E1616",strokeWidth:6,fill:"none",strokeLinecap:"round",strokeDasharray:x,strokeDashoffset:y,style:{transition:"stroke-dashoffset .2s ease"}})]}),e.jsx("div",{className:"mono",style:{fontSize:14},children:e.jsxs("div",{children:["Loading model… ",e.jsxs("span",{className:"mono",children:[f.toFixed(0),"%"]})]})})]})}function Te(t,i){a.useEffect(()=>{function d(p){t.current&&(t.current.contains(p.target)||i())}return document.addEventListener("mousedown",d),()=>document.removeEventListener("mousedown",d)},[t,i])}function A({value:t,options:i,onChange:d}){const[p,x]=a.useState(!1),f=a.useRef(null);Te(f,()=>x(!1));const y=t||i[0]||"";return e.jsxs("div",{className:"select-shell",ref:f,children:[e.jsx("div",{className:"input ctrl-xs select-display",onClick:()=>x(m=>!m),role:"button","aria-haspopup":"listbox","aria-expanded":p,children:y}),e.jsx("div",{className:"select-caret",children:"▾"}),p&&e.jsx("div",{className:"select-list",role:"listbox",children:i.map(m=>{const _=m===t;return e.jsx("div",{role:"option","aria-selected":_,className:`select-item${_?" is-active":""}`,onClick:()=>{d(m),x(!1)},children:m},m)})})]})}function Fe(){a.useEffect(()=>{ge?.()},[]);const[t,i]=a.useState(1),[d,p]=a.useState("Mon"),[x,f]=a.useState(2018),[y,m]=a.useState(""),[_,U]=a.useState(0),[T,Q]=a.useState(""),[O,X]=a.useState(0),[w,q]=a.useState(2018),[E,J]=a.useState(70),[k,Z]=a.useState(2.5),[F,ee]=a.useState(12e3),[L,se]=a.useState(0),[z,te]=a.useState(0),[I,W]=a.useState({}),ne=(s,n)=>W(r=>({...r,[s]:n})),[g,ae]=a.useState(null),[j,ie]=a.useState(null),[b,re]=a.useState(null),[le,ce]=a.useState(0),[oe,de]=a.useState(0),[ue,D]=a.useState(!0),[$,C]=a.useState(null),[R,H]=a.useState(null),[S,me]=a.useState(null),{openModal:he,Overlay:pe}=je();a.useEffect(()=>{_e(Ie).catch(()=>{})},[]),a.useEffect(()=>{Ce(we).then(s=>{ae(s);const n=Ae(s.features||[]);ie(n);const r={};for(const c of n.atomic)r[c]=0;W(c=>({...r,...c})),(s.features||[]).includes("year")&&f(2018),(s.features||[]).includes("annee")&&f(2018),n.rc_years.length&&q(n.rc_years[n.rc_years.length-1])}).catch(s=>C(String(s)))},[]),a.useEffect(()=>{fetch(Re).then(s=>s.ok?s.text():"").then(s=>{if(!s)return;const n=s.trim().split(/\r?\n/).map(o=>o.split(","));if(!n.length)return;const r=n[0].map(o=>o.trim().toLowerCase()),c=n.slice(1);let h=[];if(r.includes("feature")&&(r.includes("importance")||r.includes("gini")||r.includes("gain"))){const o=r.indexOf("feature"),v=r.indexOf("importance")>=0?r.indexOf("importance"):r.indexOf("gini")>=0?r.indexOf("gini"):r.indexOf("gain");h=c.map(N=>({feature:N[o],importance:Number(N[v])})).filter(N=>N.feature&&Number.isFinite(N.importance))}else n[0].length===2&&(h=n.map(o=>({feature:o[0],importance:Number(o[1])})).filter(o=>o.feature&&Number.isFinite(o.importance)));h.sort((o,v)=>v.importance-o.importance),h.length&&me({grid:{left:120,right:20,top:8,bottom:20},xAxis:{type:"value",name:"importance"},yAxis:{type:"category",data:h.map(o=>o.feature),axisLabel:{fontSize:11}},series:[{type:"bar",data:h.map(o=>o.importance)}],tooltip:{trigger:"item"}})}).catch(()=>{})},[]),a.useEffect(()=>{let s=!1;return D(!0),C(null),(async()=>{try{const{session:n,onDownload:r,onInit:c}=await ye(Se);r(h=>!s&&ce(h)),c(h=>!s&&de(h)),re(n)}catch(n){s||C(String(n))}finally{s||D(!1)}})(),()=>{s=!0}},[]);function xe(){const s=g?.features&&Array.isArray(g.features)?g.features:[],n=new Float32Array(s.length),r=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].indexOf(d)+1||1,c=s.includes("year")?"year":s.includes("annee")?"annee":null,h=l=>`RC_rc_${l}_etat_pci`,o=l=>`RC_rc_${l}_indice pci`,v=l=>`RC_rc_${l}_etat_iri`,N=l=>`RC_rc_${l}_indice iri`;for(let l=0;l<s.length;l++){const u=s[l];if(u==="month"){n[l]=Y(t,1,12);continue}if(u==="dow_num"){n[l]=r;continue}if(c&&u===c){n[l]=Number(x);continue}if(u.startsWith("landuse__")){const M=u.slice(9);n[l]=y===M?Number(_??0):0;continue}if(u.startsWith("poi_type__")){const M=u.slice(10);n[l]=T===M?Number(O??0):0;continue}if(u===h(w)||u===o(w)){n[l]=Number(E??0);continue}if(u===v(w)||u===N(w)){n[l]=Number(k??0);continue}if(u==="aadt"||u==="aadt_mean"){n[l]=Y(F,0,2e5);continue}if(u==="population_aw"||u==="population"){n[l]=Number(L??0);continue}if(u==="intersection_count"){n[l]=Number(z??0);continue}if(u.toLowerCase().includes("precip")){n[l]=0;continue}if(Object.prototype.hasOwnProperty.call(I,u)){n[l]=Number(I[u]??0);continue}n[l]=0}return n}const B=a.useMemo(()=>{const s=g?.features||[],n=new Set(["month","dow_num","year","annee","aadt","aadt_mean","population_aw","population","intersection_count","max_temperature_v","min_temperature_v","max_dew_point_v","min_dew_point_v","max_relative_humidity_v","min_relative_humidity_v","max_wind_speed_v","rain_v","snow_v","snow_on_ground_v","solar_radiation_v","poi_total"]),r=c=>/^RC_rc_\d{4}_(?:etat|indice)[ _]*(iri|pci).*$/i.test(c);return s.filter(c=>!n.has(c)&&!r(c)&&!c.toLowerCase().includes("precip")&&!c.startsWith("landuse__")&&!c.startsWith("poi_type__"))},[g?.features]);async function fe(){if(!(!b||!g||!g.features?.length))try{C(null),H(null);const s=xe(),n=b.inputNames&&b.inputNames[0]||"input",r=await ve(b,n,s,{batch:1,features:s.length});let c=typeof r=="number"?r:(()=>{const h=r,o=h&&Object.keys(h)[0],v=o?h[o]?.data:null;return v&&v.length?Number(v[0]):NaN})();g.is_log_target&&(c=Math.max(0,Math.exp(c)-1e-9)),H(c)}catch(s){C(String(s))}}return e.jsx("div",{className:"model-scope",children:e.jsxs("div",{className:"model-two-col",style:{gap:16,padding:"16px 24px 24px"},children:[e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("div",{className:"card-title",children:"Occurrence — Calculator"})}),ue?e.jsx("div",{style:{marginBottom:8},children:e.jsx(Pe,{pct:Math.round(.7*le+.3*oe)})}):null,$&&e.jsx("div",{style:{color:"crimson",marginBottom:8},children:$}),e.jsxs("div",{className:"form-grid",style:{marginTop:8},children:[e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"field-label",children:"Month"}),e.jsx("input",{className:"input ctrl-xs",type:"number",value:t,min:1,max:12,onChange:s=>i(Number(s.target.value))})]}),e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"field-label",children:"Day of week"}),e.jsx(A,{value:d,options:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],onChange:p})]}),(g?.features?.includes("year")||g?.features?.includes("annee"))&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"field-label",children:"Year"}),e.jsx("input",{className:"input ctrl-xs",type:"number",value:x,onChange:s=>f(Number(s.target.value))})]}),e.jsx("div",{})]})]}),j?.landuse&&j.landuse.length>0&&e.jsxs("div",{className:"form-grid",style:{marginTop:8},children:[e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"field-label",children:"Land use category"}),e.jsx(A,{value:y,options:["",...j.landuse],onChange:m})]}),e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"field-label",children:"Land use — % area"}),e.jsx("input",{className:"input ctrl-xs",type:"number",value:_,onChange:s=>U(Number(s.target.value))})]})]}),j?.poi_type&&j.poi_type.length>0&&e.jsxs("div",{className:"form-grid",style:{marginTop:8},children:[e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"field-label",children:"POI type category"}),e.jsx(A,{value:T,options:["",...j.poi_type],onChange:Q})]}),e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"field-label",children:"POI — total count"}),e.jsx("input",{className:"input ctrl-xs",type:"number",value:O,onChange:s=>X(Number(s.target.value))})]})]}),j?.rc_years?.length&&(j.rc_hasPCI||j.rc_hasIRI)?e.jsxs("div",{className:"form-grid",style:{marginTop:8},children:[j.rc_hasPCI&&e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"field-label",children:"PCI value"}),e.jsx("input",{className:"input ctrl-xs",type:"number",value:E,onChange:s=>J(Number(s.target.value))})]}),j.rc_hasIRI&&e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"field-label",children:"IRI value"}),e.jsx("input",{className:"input ctrl-xs",type:"number",value:k,onChange:s=>Z(Number(s.target.value))})]})]}):null,e.jsxs("div",{className:"form-grid",style:{marginTop:8},children:[e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"field-label",children:"AADT (veh/day)"}),e.jsx("input",{className:"input ctrl-xs",type:"number",value:F,min:0,max:2e5,onChange:s=>ee(Number(s.target.value))})]}),e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"field-label",children:"Population (area-weighted)"}),e.jsx("input",{className:"input ctrl-xs",type:"number",value:L,onChange:s=>se(Number(s.target.value))})]})]}),e.jsx("div",{className:"form-grid",style:{marginTop:8},children:e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"field-label",children:"Intersection count"}),e.jsx("input",{className:"input ctrl-xs",type:"number",value:z,onChange:s=>te(Number(s.target.value))})]})}),B.length>0&&e.jsx("div",{className:"form-grid",style:{marginTop:10},children:B.map(s=>e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"field-label",title:s,children:Me(s)}),e.jsx("input",{className:"input ctrl-xs",type:"number",value:Number.isFinite(I[s])?I[s]:0,onChange:n=>ne(s,Number(n.target.value))})]},s))}),e.jsx("div",{className:"mt-3",children:e.jsx("button",{className:"btn primary",onClick:fe,disabled:!b||!g?.features?.length,children:"Predict"})}),typeof R=="number"&&!Number.isNaN(R)&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-sm mono",children:"Predicted collisions (cell/time):"}),e.jsx("div",{style:{fontSize:24,fontWeight:600},children:R.toFixed(2)})]})]}),e.jsx("div",{className:"body-text",children:e.jsx(Ne,{})})]}),e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("div",{className:"card-title",children:"Feature importance — Gini"}),S&&e.jsx("button",{className:"icon-btn",onClick:he,title:"Full screen",children:"⤢"})]}),S?e.jsx("div",{style:{width:"100%",height:320},children:e.jsx(G,{option:S,theme:V,style:{width:"100%",height:"100%"}})}):e.jsx("div",{className:"text-sm",children:"No Gini table found."}),e.jsx(pe,{title:"Feature importance — Gini",children:S&&e.jsx("div",{className:"fullscreen-chart",style:{width:"100%",height:"100%"},children:e.jsx(G,{option:S,theme:V,style:{width:"100%",height:"100%"}})})})]}),e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("div",{className:"card-title",children:"Key indices"})}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12},className:"mono",children:[e.jsx("div",{children:["base_MAE","base_RMSE","base_R2"].map(s=>e.jsxs("div",{children:[s,": ",Number(K[s]).toFixed(6)]},s))}),e.jsx("div",{children:["final_MAE","final_RMSE","final_R2"].map(s=>e.jsxs("div",{children:[s,": ",Number(K[s]).toFixed(6)]},s))})]})]})]})]})})}export{Fe as default};
