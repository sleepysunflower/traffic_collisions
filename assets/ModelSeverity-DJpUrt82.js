import{j as e,R as h,a as A,E as U}from"./index-CghtBx9r.js";import{r as de,u as me,l as ue,g as he,m as z,a as xe}from"./mtheme-CwRuiclT.js";function pe(){return e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"About this model"}),e.jsxs("details",{open:!0,children:[e.jsx("summary",{children:"Objective"}),e.jsx("div",{className:"text-sm",style:{marginTop:8,lineHeight:1.6},children:e.jsxs("p",{children:["Model collision ",e.jsx("strong",{children:"severity levels"})," (from property damage to fatal) with a Random-Forest–based ",e.jsx("strong",{children:"ordinal regressor"}),". Each ",e.jsx("em",{children:"collision record"})," is one observation."]})})]}),e.jsxs("details",{style:{marginTop:10},open:!0,children:[e.jsx("summary",{children:"Prepreprocessing"}),e.jsxs("div",{className:"text-sm",style:{marginTop:8,lineHeight:1.6},children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Numeric features:"})," vehicle counts (",e.jsx("code",{children:"nb_*"}),"),"," ",e.jsx("code",{children:"VITESSE_AUTOR"}),", year (",e.jsx("code",{children:"AN"}),"), month, quarter, hour."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Categorical features:"}),' all coded variables from the "Collisions routières" dataset (e.g., ',e.jsx("code",{children:"CD_GENRE_ACCDN"}),", ",e.jsx("code",{children:"CD_ETAT_SURFC"}),","," ",e.jsx("code",{children:"CD_COND_METEO"}),", etc.)."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Missing values:"})," imputed (median for numeric, most-frequent for categorical)."]})]})]}),e.jsxs("details",{style:{marginTop:10},open:!0,children:[e.jsx("summary",{children:"Target"}),e.jsxs("div",{className:"text-sm",style:{marginTop:8,lineHeight:1.6},children:[e.jsxs("p",{children:[e.jsx("code",{children:"GRAVITE"})," — 5 ordered categories mapped to integer codes ",e.jsx("code",{children:"0–4"}),":"]}),e.jsxs("ul",{style:{marginLeft:18},children:[e.jsx("li",{children:"0 — Below reporting threshold"}),e.jsx("li",{children:"1 — Material damage only"}),e.jsx("li",{children:"2 — Minor injury"}),e.jsx("li",{children:"3 — Serious injury"}),e.jsx("li",{children:"4 — Fatal"})]})]})]}),e.jsxs("details",{style:{marginTop:10},open:!0,children:[e.jsx("summary",{children:"Modeling workflow"}),e.jsx("div",{className:"text-sm",style:{marginTop:8,lineHeight:1.6},children:e.jsxs("p",{children:["Train a ",e.jsx("strong",{children:"RandomForestRegressor"})," as an ordinal regressor that predicts a continuous ",e.jsx("em",{children:"severity score"}),". After training, perform a grid search to find"," ",e.jsx("strong",{children:"optimal thresholds"})," that map the score back into the 5 classes, maximizing"," ",e.jsx("strong",{children:"Quadratic Weighted Kappa (QWK)"})," for robust ordinal agreement."]})})]})]})}const fe=A("data/models/severity_reg.onnx"),ge=A("data/models/severity_reg_meta.json"),je=A("data/dictionary.json"),ye=A("data/models/severity_metrics.json"),be=A("data/models/severity_perm.csv");function Ne({pct:d}){const o=2*Math.PI*25,f=Math.max(0,Math.min(100,d)),l=o*(1-f/100);return e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12},children:[e.jsxs("svg",{width:56,height:56,viewBox:"0 0 56 56",children:[e.jsx("circle",{cx:56/2,cy:56/2,r:25,stroke:"#2a2a2a",strokeWidth:6,fill:"none"}),e.jsx("circle",{cx:56/2,cy:56/2,r:25,stroke:"#8E1616",strokeWidth:6,fill:"none",strokeLinecap:"round",strokeDasharray:o,strokeDashoffset:l,style:{transition:"stroke-dashoffset .2s ease"}})]}),e.jsx("div",{className:"mono",style:{fontSize:14},children:e.jsxs("div",{children:["Loading model… ",e.jsxs("span",{className:"mono",children:[f.toFixed(0),"%"]})]})})]})}function N(d){return d.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim()}const ve=["nb motocyclette","nb bicyclette","nb automobile camion leger"].map(N);function _e(d){const i=N(d);return ve.some(m=>i.includes(m))}const M={CD_ASPCT_ROUTE:"ROUTE_ASPECT",ASPCT_ROUTE:"ROUTE_ASPECT"};function W(d,i){if(!d)return null;const m=[i,i.toUpperCase(),`CD_${i}`,`CD_${i}`.toUpperCase(),M[i]||"",M[i?.toUpperCase?.()]||""].filter(Boolean);for(const r of m)if(d[r])return d[r];return null}function E(d,i){const m=d?.__labels__;if(m){const f=[i,i.toUpperCase(),`CD_${i}`,`CD_${i}`.toUpperCase(),M[i]||"",M[i?.toUpperCase?.()]||""].filter(Boolean);for(const l of f)if(typeof m[l]=="string")return m[l]}const r=W(d,i);if(r&&typeof r=="object"&&typeof r.label=="string")return r.label;if(N(i).includes("nb automobile camion leger"))return"Number of automobile";if(N(i).includes("nb bicyclette"))return"Number of bicycle";if(N(i).includes("nb motocyclette"))return"Number of motorcycle";const o=i.toUpperCase();return o==="JR_SEMN_ACCDN"?"Day of the week":o.includes("HEURE")||o==="HR_ACCDN"||o==="HEURE_ACCDN"?"Time of day":i.replaceAll("_"," ")}function D(d,i,m){const r=W(d,i);if(r&&typeof r=="object"){if(Object.prototype.hasOwnProperty.call(r,m))return String(r[m]);const o=Number(m);if(Number.isFinite(o)&&Object.prototype.hasOwnProperty.call(r,o))return String(r[o])}return m}function Ce(d){let i=null,m=null;for(const r of d){const o=r.toUpperCase(),f=N(r);!i&&(o.includes("HEURE")||o.includes("HR_ACCDN")||o.includes("HEURE_ACCDN")||f.includes("time"))&&(i=r),!m&&(o.includes("JR_SEMN")||f.includes("day of week")||f.includes("weekday"))&&(m=r)}return{timeOfDay:i,dayOfWeek:m}}const Se=new Set(["work_zone","workzone","zone_travaux","travaux","work_zone_ind","work_zone_indicator"].map(N));function Ee(d,i){h.useEffect(()=>{function m(r){d.current&&(d.current.contains(r.target)||i())}return document.addEventListener("mousedown",m),()=>document.removeEventListener("mousedown",m)},[d,i])}function R({value:d,options:i,onChange:m,display:r}){const[o,f]=h.useState(!1),l=h.useRef(null);Ee(l,()=>f(!1));const O=d?r(d):i[0]?r(i[0]):"";return e.jsxs("div",{className:"select-shell",ref:l,children:[e.jsx("div",{className:"input ctrl-xs select-display",onClick:()=>f(j=>!j),role:"button","aria-haspopup":"listbox","aria-expanded":o,children:O}),e.jsx("div",{className:"select-caret",children:"▾"}),o&&e.jsx("div",{className:"select-list",role:"listbox",children:i.map(j=>{const T=j===d;return e.jsx("div",{role:"option","aria-selected":T,className:`select-item${T?" is-active":""}`,onClick:()=>{m(j),f(!1)},children:r(j)},String(j))})})]})}function we(){h.useEffect(()=>{de?.()},[]);const[d,i]=h.useState({}),[m,r]=h.useState({}),[o,f]=h.useState(null),[l,O]=h.useState(null),[j,T]=h.useState(null),[V,$]=h.useState(0),[K,q]=h.useState(0),[G,L]=h.useState(!0),[H,v]=h.useState(null),[F,I]=h.useState(null),[P,B]=h.useState(null),[u,Q]=h.useState(null),{openModal:X,Overlay:J}=me(),[C,Y]=h.useState(null);h.useEffect(()=>{ue(je).then(f).catch(()=>{}),fetch(ge).then(t=>t.ok?t.json():Promise.reject("meta")).then(t=>{O(t);const s={};(t.num_cols||[]).forEach(x=>{const n=t.num_fill&&t.num_fill[x]!=null?Number(t.num_fill[x]):0;s[x]=Number.isFinite(n)?n:0});const c={};(t.cat_cols||[]).forEach(x=>{const n=t.cat_categories?.[x]||[];c[x]=n.length?String(n[0]):""}),i(s),r(c)}).catch(t=>v(String(t))),fetch(ye).then(t=>t.ok?t.json():null).then(t=>{t&&Q(t)}).catch(()=>{}),fetch(be).then(t=>t.ok?t.text():"").then(t=>{if(!t)return;const s=t.trim().split(/\r?\n/).map(a=>a.split(","));if(!s.length)return;const c=s[0].map(a=>a.trim().toLowerCase()),x=s.slice(1);let n=[];if(c.includes("feature")&&c.some(a=>["importance","perm","permutation"].includes(a))){const a=c.indexOf("feature"),g=["importance","perm","permutation"].map(p=>c.indexOf(p)).find(p=>p>=0)??1;n=x.map(p=>({feature:p[a],importance:Number(p[g])})).filter(p=>p.feature&&Number.isFinite(p.importance))}else s[0].length===2&&(n=s.map(a=>({feature:a[0],importance:Number(a[1])})).filter(a=>a.feature&&Number.isFinite(a.importance)));n.sort((a,g)=>g.importance-a.importance),n.length&&Y({grid:{left:120,right:20,top:8,bottom:20},xAxis:{type:"value",name:"importance"},yAxis:{type:"category",data:n.map(a=>a.feature),axisLabel:{fontSize:11}},series:[{type:"bar",data:n.map(a=>a.importance)}],tooltip:{trigger:"item"}})}).catch(()=>{})},[]),h.useEffect(()=>{let t=!1;return L(!0),v(null),(async()=>{try{const{session:s,onDownload:c,onInit:x}=await he(fe);c(n=>!t&&$(n)),x(n=>!t&&q(n)),T(s)}catch(s){t||v(String(s))}finally{t||L(!1)}})(),()=>{t=!0}},[]);function Z(t,s){return Math.round(Math.max(0,Math.min(100,.7*t+.3*s)))}function ee(){if(!l)return new Float32Array(0);const{num_cols:t=[],cat_cols:s=[],cat_categories:c={}}=l,x=t.map(g=>{const p=d[g];if(Number.isFinite(p))return Number(p);const _=l.num_fill&&l.num_fill[g]!=null?Number(l.num_fill[g]):0;return Number.isFinite(_)?_:0}),n=[];for(const g of s){const p=c[g]||[],_=String(m[g]??p[0]??"");if(p.length)for(const ce of p)n.push(String(ce)===_?1:0);else n.push(Number.isFinite(Number(_))?Number(_):0)}const a=new Float32Array(x.length+n.length);return a.set(x,0),a.set(n,x.length),a}function te(t){if(!l)return"Unknown";const s=l.thresholds||[];let c=0;for(;c<s.length&&t>=s[c];)c++;return l.severity_labels[c]??`Class ${c}`}async function se(){if(!(!j||!l))try{v(null),I(null),B(null);const t=ee();if(!t.length){v("Design vector is empty. Check severity_reg_meta.json.");return}const s=l.input_name||j.inputNames&&j.inputNames[0]||"input",c=await xe(j,s,t,{batch:1,features:t.length});let x=typeof c=="number"?c:(()=>{const n=c,a=n&&Object.keys(n)[0],g=a?n[a]?.data:null;return g&&g.length?Number(g[0]):NaN})();I(x),B(te(x))}catch(t){v(String(t))}}const ie=!!j&&!!l,w=l?.cat_cols??[],{timeOfDay:y,dayOfWeek:b}=Ce(w),ne=["CD_COND_METEO","COND_METEO","CD_ECLRM","ECLRM","CD_ETAT_SURFC","ETAT_SURFC"],S=[];for(const t of ne)w.includes(t)&&S.push(t);for(const t of w){const s=t.toUpperCase();(s.includes("COND")&&s.includes("METEO")||s.includes("ECLRM")||s.includes("ETAT_SURFC"))&&(S.includes(t)||S.push(t))}const re=new Set([y||"",b||"",...S].filter(Boolean)),ae=w.filter(t=>re.has(t)?!1:!Se.has(N(t))),le=(l?.num_cols??[]).filter(_e),k=h.useMemo(()=>{if(!u?.confusion_matrix)return null;const t=u.labels&&u.labels.length?u.labels:[],s=[];for(let n=0;n<u.confusion_matrix.length;n++)for(let a=0;a<u.confusion_matrix[n].length;a++)s.push([a,n,u.confusion_matrix[n][a]]);const c=Math.max(...s.map(n=>n[2]));return{tooltip:{position:"top"},grid:{left:70,right:10,bottom:10,top:6},xAxis:{type:"category",data:t,name:"Predicted",axisLabel:{rotate:25,fontSize:11}},yAxis:{type:"category",data:t,name:"True",axisLabel:{fontSize:11}},visualMap:{show:!1,min:0,max:c,inRange:{color:["#262626","#8E1616","#D84040"]}},series:[{type:"heatmap",data:s,label:{show:!0,color:"#fff",fontWeight:600,fontSize:11}}]}},[u]),oe=Z(V,K);return e.jsx("div",{className:"model-scope",children:e.jsxs("div",{className:"model-two-col",style:{gap:16,padding:"16px 24px 24px"},children:[e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("div",{className:"card-title",children:"Severity — Calculator"})}),G?e.jsx("div",{style:{marginBottom:8},children:e.jsx(Ne,{pct:oe})}):null,H&&e.jsx("div",{style:{color:"crimson",marginBottom:8},children:H}),l?e.jsxs("div",{className:"form-grid",style:{marginTop:8},children:[y&&e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"field-label",children:E(o,y)}),e.jsx(R,{value:m[y]??l.cat_categories[y]?.[0]??"",options:l.cat_categories[y]||[],onChange:t=>r(s=>({...s,[y]:String(t)})),display:t=>D(o,y,String(t))})]}),b&&e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"field-label",children:E(o,b)}),e.jsx(R,{value:m[b]??l.cat_categories[b]?.[0]??"",options:l.cat_categories[b]||[],onChange:t=>r(s=>({...s,[b]:String(t)})),display:t=>D(o,b,String(t))})]}),le.map(t=>e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"field-label",children:E(o,t)}),e.jsx("input",{className:"input ctrl-xs",inputMode:"numeric",type:"number",value:Number.isFinite(d[t])?d[t]:0,onChange:s=>i(c=>({...c,[t]:Number(s.target.value)}))})]},t)),S.map(t=>e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"field-label",children:E(o,t)}),e.jsx(R,{value:m[t]??l.cat_categories[t]?.[0]??"",options:l.cat_categories[t]||[],onChange:s=>r(c=>({...c,[t]:String(s)})),display:s=>D(o,t,String(s))})]},t)),ae.map(t=>e.jsxs("label",{className:"field",children:[e.jsx("span",{className:"field-label",children:E(o,t)}),e.jsx(R,{value:m[t]??l.cat_categories[t]?.[0]??"",options:l.cat_categories[t]||[],onChange:s=>r(c=>({...c,[t]:String(s)})),display:s=>D(o,t,String(s))})]},t))]}):e.jsx("div",{className:"text-sm",children:"Loading form…"}),e.jsx("div",{className:"mt-3",children:e.jsx("button",{className:"btn primary",onClick:se,disabled:!ie,children:"Predict"})}),(P||F!=null)&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-sm mono",children:"Predicted severity:"}),P&&e.jsx("div",{style:{fontSize:20,fontWeight:600},children:P}),F!=null&&e.jsxs("div",{className:"text-sm",children:["Model score: ",e.jsx("span",{className:"mono",children:F.toFixed(3)})]})]})]}),e.jsx("div",{className:"body-text",children:e.jsx(pe,{})})]}),e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"card",style:{minHeight:380},children:[e.jsx("div",{className:"card-header",children:e.jsx("div",{className:"card-title",children:"Confusion Matrix"})}),k?e.jsx(U,{option:{...k,grid:{left:90,right:20,top:20,bottom:60},xAxis:{...k.xAxis,axisLabel:{rotate:35,fontSize:12,color:"#ddd"},nameGap:30},yAxis:{...k.yAxis,axisLabel:{fontSize:12,color:"#ddd"},nameGap:30}},theme:z,style:{width:"100%",height:320}}):e.jsx("div",{className:"text-sm",children:"No confusion matrix available."})]}),e.jsxs("div",{className:"card body-text",children:[e.jsx("div",{className:"card-header",children:e.jsx("div",{className:"card-title",children:"Key indices"})}),u?.per_class?e.jsx("div",{style:{maxHeight:300,overflow:"auto",border:"1px solid #2a2a2a",borderRadius:10},children:e.jsxs("table",{className:"text-sm mono",style:{width:"100%",borderCollapse:"separate",borderSpacing:0},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{background:"#121212"},children:[e.jsx("th",{style:{textAlign:"left",padding:"8px 10px",borderBottom:"1px solid #2a2a2a"},children:"Class"}),e.jsx("th",{style:{textAlign:"right",padding:"8px 10px",borderBottom:"1px solid #2a2a2a"},children:"Precision"}),e.jsx("th",{style:{textAlign:"right",padding:"8px 10px",borderBottom:"1px solid #2a2a2a"},children:"Recall"}),e.jsx("th",{style:{textAlign:"right",padding:"8px 10px",borderBottom:"1px solid #2a2a2a"},children:"F1"}),e.jsx("th",{style:{textAlign:"right",padding:"8px 10px",borderBottom:"1px solid #2a2a2a"},children:"Support"})]})}),e.jsx("tbody",{children:u.per_class.map((t,s)=>e.jsxs("tr",{style:{background:s%2?"#0f0f0f":"transparent"},children:[e.jsx("td",{style:{padding:"6px 10px"},children:t.label}),e.jsx("td",{style:{padding:"6px 10px",textAlign:"right"},children:t.precision==null?"":t.precision.toFixed(3)}),e.jsx("td",{style:{padding:"6px 10px",textAlign:"right"},children:t.recall==null?"":t.recall.toFixed(3)}),e.jsx("td",{style:{padding:"6px 10px",textAlign:"right"},children:t.f1==null?"":t.f1.toFixed(3)}),e.jsx("td",{style:{padding:"6px 10px",textAlign:"right"},children:t.support==null?"":t.support})]},t.label))})]})}):e.jsx("div",{className:"text-sm",children:"No classification report."}),u?.overall?e.jsxs("div",{className:"mono",style:{display:"flex",gap:24,flexWrap:"wrap",marginTop:10},children:["qwk"in u.overall&&e.jsxs("div",{children:["QWK: ",Number(u.overall.qwk).toFixed(4)]}),"threshold_0"in u.overall&&e.jsxs("div",{children:["t0: ",Number(u.overall.threshold_0).toFixed(3)]}),"threshold_1"in u.overall&&e.jsxs("div",{children:["t1: ",Number(u.overall.threshold_1).toFixed(3)]}),"threshold_2"in u.overall&&e.jsxs("div",{children:["t2: ",Number(u.overall.threshold_2).toFixed(3)]}),"threshold_3"in u.overall&&e.jsxs("div",{children:["t3: ",Number(u.overall.threshold_3).toFixed(3)]})]}):null]}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("div",{className:"card-title",children:"Feature importance — Permutation"}),C&&e.jsx("button",{className:"icon-btn",onClick:X,title:"Full screen",children:"⤢"})]}),C?e.jsx("div",{style:{width:"100%",height:320},children:e.jsx(U,{option:C,theme:z,style:{width:"100%",height:"100%"}})}):e.jsx("div",{className:"text-sm",children:"No permutation table found."}),e.jsx(J,{title:"Feature importance — Permutation",children:C&&e.jsx("div",{className:"fullscreen-chart",style:{width:"100%",height:"100%"},children:e.jsx(U,{option:C,theme:z,style:{width:"100%",height:"100%"}})})})]})]})]})})}export{we as default};
